<?php
$servername = "localhost";
$username = "root";
$password = "";
$database = "user_registration";

// Create a connection
$conn = mysqli_connect($servername, $username, $password, $database);

if (!$conn) {
    die("Sorry, we failed to connect: " . mysqli_connect_error());
}

// initialize message variable. initially by default db has "NULL" for every user's feedback
// and value gets updated everytime the user submits feedback form again

$message = "No feedback submitted.";

//  feedback form submission:
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['feedback'])) {
    // get the feedback and username
    $feedback = $_POST['feedback'];
    $username = isset($_POST['username']) ? mysqli_real_escape_string($conn, $_POST['username']) : '';

    // format feedback log entry
    $timestamp = date('Y-m-d H:i:s');
    $log_entry = "User-Feedback-Header: $feedback | by user: $username | at $timestamp";

    if ($username) {
        // update feedback for the specified user
        $update_sql = "UPDATE login SET feedback='$feedback' WHERE username='$username'";
        if (mysqli_query($conn, $update_sql)) {
            $message = "Feedback submitted successfully.";
        } else {
            $message = "Error submitting feedback: " . mysqli_error($conn);
        }

        // log the feedback in a log file
        file_put_contents('feedback.log', $log_entry . PHP_EOL, FILE_APPEND);
    } else {
        $message = "No username provided.";
    }

    // display log entry directly in HTML
    echo "<!DOCTYPE html>
    <html>
    <head>
        <title>Feedback Submission</title>
    </head>
    <style>
    h3 {
        color: #4682b4;
    }
    </style>
    <body>
        <h3>$message</h3>
        <p>$log_entry</p>
    </body>
    </html>";

    mysqli_close($conn);

    // stop further exec to ensure resp is displayed correctly
    exit();
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Feedback Submission</title>
</head>
<style>
h3 {
    color: #4682b4;
}
</style>
<body>
    <h3><?php echo $message; ?></h3>
</body>
</html>
